#include <stdio.h>
#include <stdlib.h>
#include "marching.h"
#define SIGMA 200

int **alloc_retea(int n, int m)
{
	int **r = (int **)malloc(n * sizeof(int *));
	if (!r) {
		printf("Eroare: Malloc a esuat:(\n");
		exit(0);
	}
	for (int i = 0; i < n; i++) {
		r[i] = (int *)malloc(m * sizeof(int));
		if (!r[i]) {
			printf("Eroare: Malloc a esuat:(\n");
			for (int j = 0; j < i; j++) {
				free(r[i]);
			}
			free(r);
			exit(0);
		}
	}

	return r;
}

//medie elemente vecine de pe diagonala
int med_vec(RGB_t **ppm, int i, int j, int n, int m)
{
	int cnt = 1, s =  med_px(ppm, i, j);

	if (i > 0 && j > 0) {
		s += med_px(ppm, i - 1, j - 1);
		cnt++;
	}
	if (i < n - 1 && j < m - 1) {
		s += med_px(ppm, i + 1, j + 1);
		cnt++;
	}
	if (j > 0 && i < n - 1) {
		s += med_px(ppm, i + 1, j - 1);
		cnt++;
	}
	if (j < m - 1 && i > 0) {
		s += med_px(ppm, i - 1, j + 1);
		cnt++;
	}

	return s / cnt;
}

//elemetele de pe margine
int marg_vec(RGB_t **ppm, int i, int j, int n, int m)
{
	if (j == m - 1) {
		int s = 0, cnt = 0;
		if (i > 0) {
			s += med_px(ppm, i - 1, j);
			cnt++;
		}
		if (i < n - 1) {
			s += med_px(ppm, i + 1, j);
			cnt++;
		}

		return s / cnt;
	}

	int s = 0, cnt = 0;
	if (j > 0) {
		s += med_px(ppm, i, j - 1);
		cnt++;
	}
	if (j < m - 1) {
		s += med_px(ppm, i, j + 1);
		cnt++;
	}

	return s / cnt;
}

void init_retea(int ***r, RGB_t **ppm, int *n, int *m)
{
	int rn = (*n) / 4 + 1, rm = (*m) / 4 + 1;
	*r = alloc_retea(rn, rm);
	for (int i = 0; i < (*n); i += 4) {
		for (int j = 0; j < (*m); j += 4) {
			(*r)[i / 4][j / 4] = med_vec(ppm, i, j, (*n), (*m));
		}
	}
	for (int i = 0; i < (*n); i += 4) {
		(*r)[i / 4][rm - 1] = marg_vec(ppm, i, (*m) - 1, (*n), (*m));
	}
	for (int j = 0; j < (*m); j += 4) {
		(*r)[rn - 1][j / 4] = marg_vec(ppm, (*n) - 1, j, (*n), (*m));
	}
	(*r)[rn - 1][rm - 1] = med_px(ppm, (*n) - 1, (*m) - 1);
	for (int i = 0; i < rn; i++) {
		for (int j = 0; j < rm; j++) {
			if ((*r)[i][j] <= SIGMA) {
				(*r)[i][j] = 1;
			} else {
				(*r)[i][j] = 0;
			}
		}
	}
	(*n) = (*n) / 4 + 1;
	(*m) = (*m) / 4 + 1;
}

void free_retea(int **r, int n)
{
	for (int i = 0; i < n; i++) {
		free(r[i]);
	}
	free(r);
}

//functii de initializare a matricei de contur
contur_t contur_0(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_1(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{255, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_2(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {255, 255, 255}},
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_3(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_4(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {255, 255, 255}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_5(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {255, 255, 255}},
			{{255, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_6(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}},
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}},
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}},
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_7(void)
{
	contur_t a = {
		{
			{{0, 0, 0}, {255, 255, 255}, {180, 180, 180}, {180, 180, 180}},
			{{255, 255, 255}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_8(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}},
			{{255, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_9(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}},
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}},
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}},
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_10(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {255, 255, 255}, {0, 0, 0}, {0, 0, 0}},
			{{255, 255, 255}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {255, 255, 255}},
			{{0, 0, 0}, {0, 0, 0}, {255, 255, 255}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_11(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {180, 180, 180}, {255, 255, 255}, {0, 0, 0}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {255, 255, 255}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_12(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}},
			{{0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_13(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {255, 255, 255}},
			{{180, 180, 180}, {180, 180, 180}, {255, 255, 255}, {0, 0, 0}}
		}
	};

	return a;
}

contur_t contur_14(void)
{
	contur_t a = {
		{
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{180, 180, 180}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{255, 255, 255}, {180, 180, 180},
			{180, 180, 180}, {180, 180, 180}},
			{{0, 0, 0}, {255, 255, 255}, {180, 180, 180}, {180, 180, 180}}
		}
	};

	return a;
}

contur_t contur_15(void)
{
	contur_t a = {
		{
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}},
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}},
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}},
			{{255, 255, 255}, {255, 255, 255},
			{255, 255, 255}, {255, 255, 255}}
		}
	};

	return a;
}

//cauta contutul potrivit
contur_t init_contur(int r)
{
	contur_t a;
	if (r == 0) {
		a = contur_0();
	} else if (r == 1) {
		a = contur_1();
	} else if (r == 2) {
		a = contur_2();
	} else if (r == 3) {
		a = contur_3();
	} else if (r == 4) {
		a = contur_4();
	} else if (r == 5) {
		a = contur_5();
	} else if (r == 6) {
		a = contur_6();
	} else if (r == 7) {
		a = contur_7();
	} else if (r == 8) {
		a = contur_8();
	} else if (r == 9) {
		a = contur_9();
	} else if (r == 10) {
		a = contur_10();
	} else if (r == 11) {
		a =  contur_11();
	} else if (r == 12) {
		a =  contur_12();
	} else if (r == 13) {
		a =  contur_13();
	} else if (r == 14) {
		a =  contur_14();
	} else if (r == 15) {
		a =  contur_15();
	}

	return a;
}
